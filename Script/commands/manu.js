const fs = require("fs");
const path = require("path");

const DATA_DIR = path.join(__dirname, "..", "..", "cache");
const CONF_PATH = path.join(DATA_DIR, "manu.config.json");
const DISABLED_CMDS_PATH = path.join(DATA_DIR, "disabled.commands.json");
const BLOCKED_THREADS_PATH = path.join(DATA_DIR, "blocked.threads.json");
const COMMANDS_DIR = path.join(__dirname); // this file's folder (commands)

function ensureFiles() {
  if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });
  if (!fs.existsSync(CONF_PATH)) fs.writeFileSync(CONF_PATH, JSON.stringify({
    setupDone: false,
    prefix: "",            //optional storage; won‚Äôt override bot core
    ownerNote: "Welcome to MANU Control Center"
  }, null, 2));
  if (!fs.existsSync(DISABLED_CMDS_PATH)) fs.writeFileSync(DISABLED_CMDS_PATH, JSON.stringify([], null, 2));
  if (!fs.existsSync(BLOCKED_THREADS_PATH)) fs.writeFileSync(BLOCKED_THREADS_PATH, JSON.stringify([], null, 2));
}

function readJSON(p) {
  ensureFiles();
  try { return JSON.parse(fs.readFileSync(p, "utf8")); } catch { return {}; }
}
function writeJSON(p, data) {
  ensureFiles();
  fs.writeFileSync(p, JSON.stringify(data, null, 2));
}

function listCommands() {
  // List *.js in commands folder (excluding this file)
  const files = fs.readdirSync(COMMANDS_DIR)
    .filter(f => f.endsWith(".js") && f !== path.basename(__filename))
    .map(f => f.replace(/\.js$/, ""));
  return files;
}

module.exports.config = {
  name: "manu",
  version: "1.0.0",
  hasPermssion: 2, // admin only (change to 0 if you want)
  credits: "rX Abdullah + ChatGPT",
  description: "Bot Control Center (Menu + Setup)",
  commandCategory: "system",
  usages: "manu",
  cooldowns: 2
};

// ‡¶≠‡¶æ‡¶∑‡¶æ (‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§)
const T = {
  title: "üîß MANU ‚Ä¢ Control Center",
  ask: "‡¶Ø‡ßá ‡¶Ö‡¶™‡¶∂‡¶®‡¶ü‡¶ø ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®:",
  opts: [
    "Setup / Finish setup",
    "Show current status",
    "Toggle a command ON/OFF",
    "Delete a command file (safe)",
    "Turn BOT OFF in this chat",
    "Turn BOT ON in this chat",
    "Restart bot (process.exit)"
  ],
  done: "‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!",
  cancel: "‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§",
  needAdmin: "‡¶è‡¶á ‡¶Ö‡¶™‡¶∂‡¶® ‡¶ö‡¶æ‡¶≤‡¶æ‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶≤‡¶æ‡¶ó‡ßá‡•§",
  confirmDel: (name)=>`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‚Äú${name}.js‚Äù ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (yes/no)`,
  notFound: "‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§",
  already: "‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶∏‡ßá‡¶ü ‡¶õ‡¶ø‡¶≤‡•§",
  turnedOff: "‡¶è‡¶á ‡¶•‡ßç‡¶∞‡ßá‡¶°‡ßá ‡¶¨‡¶ü OFF ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§",
  turnedOn: "‡¶è‡¶á ‡¶•‡ßç‡¶∞‡ßá‡¶°‡ßá ‡¶¨‡¶ü ON ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§"
};

// ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶ó‡¶æ‡¶∞‡ßç‡¶°: setupDone ‡¶®‡¶æ ‡¶π‡¶≤‡ßá‚Äîsetup ‡¶è‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü
module.exports.handleEvent = async function({ api, event }) {
  try {
    if (!event || !event.body) return;
    ensureFiles();
    const conf = readJSON(CONF_PATH);
    const blockedThreads = readJSON(BLOCKED_THREADS_PATH);
    const isBlocked = Array.isArray(blockedThreads) && blockedThreads.includes(event.threadID);

    // ‡¶¨‡ßç‡¶≤‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®/‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶á ‡¶ö‡¶≤‡¶¨‡ßá ‡¶®‡¶æ
    if (isBlocked) return;

    if (!conf.setupDone) {
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ø‡¶ñ‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (‡¶∏‡¶π‡¶ú‡¶≠‡¶æ‡¶¨‡ßá: ‡¶∏‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶∂/‡¶™‡ßç‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü) ‡¶§‡¶ñ‡¶® ‡¶ó‡¶æ‡¶á‡¶° ‡¶¶‡ßá‡¶á
      const body = (event.body || "").trim();
      const looksLikeCmd = /^[!/.#]/.test(body) && !/^manu(\s|$)/i.test(body);
      if (looksLikeCmd) {
        api.sendMessage(
          "üõ†Ô∏è ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶¨‡¶ü ‡¶ï‡ßÅ‡¶á‡¶ï ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\nüëâ `manu` ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ 1 ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (Setup).",
          event.threadID
        );
      }
    }
  } catch {}
};

// ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶∞‡¶æ‡¶®
module.exports.run = async function({ api, event, args }) {
  ensureFiles();
  const disabled = readJSON(DISABLED_CMDS_PATH);
  const conf = readJSON(CONF_PATH);
  const blockedThreads = readJSON(BLOCKED_THREADS_PATH);

  // ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã
  const statusLines = [
    `‚Ä¢ Setup: ${conf.setupDone ? "‚úÖ Done" : "‚ùå Not done"}`,
    `‚Ä¢ Owner note: ${conf.ownerNote || "-"}`,
    `‚Ä¢ This thread: ${blockedThreads.includes(event.threadID) ? "üö´ BOT OFF" : "üü¢ BOT ON"}`
  ];

  const menu =
`${T.title}
${statusLines.join("\n")}

1) ${T.opts[0]}
2) ${T.opts[1]}
3) ${T.opts[2]}
4) ${T.opts[3]}
5) ${T.opts[4]}
6) ${T.opts[5]}
7) ${T.opts[6]}

${T.ask}`;

  return api.sendMessage(menu, event.threadID, (err, info) => {
    if (err) return;
    global.client.handleReply.push({
      name: module.exports.config.name,
      messageID: info.messageID,
      author: event.senderID,
      type: "menu"
    });
  });
};

// ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞
module.exports.handleReply = async function (o) {
  const { api, event, handleReply } = o;
  if (event.senderID != handleReply.author) return;
  ensureFiles();

  const conf = readJSON(CONF_PATH);
  const disabled = readJSON(DISABLED_CMDS_PATH);
  const blockedThreads = readJSON(BLOCKED_THREADS_PATH);

  const reply = (msg, cb) => api.sendMessage(msg, event.threadID, cb);

  // ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤
  if (handleReply.type === "menu") {
    const choice = (event.body || "").trim();

    switch (choice) {
      case "1": {
        // Setup flow
        const q =
`‚öôÔ∏è Quick Setup
1) Set owner note
2) Mark setup as DONE
3) Mark setup as NOT DONE
0) Back

${T.ask}`;
        return reply(q, (err, info) => {
          if (err) return;
          global.client.handleReply.push({
            name: module.exports.config.name,
            messageID: info.messageID,
            author: event.senderID,
            type: "setupMenu"
          });
        });
      }
      case "2": {
        // Show status
        const cmds = listCommands();
        const disabledSet = new Set(disabled);
        const lines = cmds.slice(0, 40).map(n => `‚Ä¢ ${n} ${disabledSet.has(n) ? "‚Äî OFF" : "‚Äî ON"}`);
        return reply(`üìä Current Status:\n- Setup: ${conf.setupDone ? "‚úÖ Done" : "‚ùå Not done"}\n- Owner note: ${conf.ownerNote || "-"}\n- Thread: ${blockedThreads.includes(event.threadID) ? "üö´ BOT OFF" : "üü¢ BOT ON"}\n\nüß© Commands (${lines.length} shown):\n${lines.join("\n")}`);
      }
      case "3": {
        // Toggle command ON/OFF
        const list = listCommands();
        if (list.length === 0) return reply("‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        const menu = list.map((n,i)=>`${i+1}) ${n}`).join("\n");
        return reply(`üîÅ ‡¶ï‡ßã‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ON/OFF ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n${menu}\n\n${T.ask}`, (err, info) => {
          if (err) return;
          global.client.handleReply.push({
            name: module.exports.config.name,
            messageID: info.messageID,
            author: event.senderID,
            type: "togglePick",
            cmds: list
          });
        });
      }
      case "4": {
        // Delete command (safe)
        const list = listCommands();
        if (list.length === 0) return reply("‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        const menu = list.map((n,i)=>`${i+1}) ${n}`).join("\n");
        return reply(`üóëÔ∏è ‡¶ï‡ßã‡¶® ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?\n${menu}\n\n${T.ask}`, (err, info) => {
          if (err) return;
          global.client.handleReply.push({
            name: module.exports.config.name,
            messageID: info.messageID,
            author: event.senderID,
            type: "deletePick",
            cmds: list
          });
        });
      }
      case "5": {
        // Turn bot OFF in this chat
        if (!blockedThreads.includes(event.threadID)) {
          blockedThreads.push(event.threadID);
          writeJSON(BLOCKED_THREADS_PATH, blockedThreads);
        }
        return reply(T.turnedOff);
      }
      case "6": {
        // Turn bot ON in this chat
        const idx = blockedThreads.indexOf(event.threadID);
        if (idx !== -1) {
          blockedThreads.splice(idx,1);
          writeJSON(BLOCKED_THREADS_PATH, blockedThreads);
          return reply(T.turnedOn);
        }
        return reply(T.already);
      }
      case "7": {
        reply("‚ôªÔ∏è ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", () => {
          // ‡¶õ‡¶æ‡ßá‡¶ü‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡ßá ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
          setTimeout(()=>process.exit(1), 500);
        });
        return;
      }
      default:
        return reply(T.cancel);
    }
  }

  // Setup submenu
  if (handleReply.type === "setupMenu") {
    const choice = (event.body || "").trim();
    switch (choice) {
      case "1": {
        return reply("‚úçÔ∏è Owner note ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®:", (err, info) => {
          if (err) return;
          global.client.handleReply.push({
            name: module.exports.config.name,
            messageID: info.messageID,
            author: event.senderID,
            type: "ownerNote"
          });
        });
      }
      case "2": {
        conf.setupDone = true;
        writeJSON(CONF_PATH, conf);
        return reply("‚úÖ Setup DONE ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶π‡¶≤‡ßã‡•§");
      }
      case "3": {
        conf.setupDone = false;
        writeJSON(CONF_PATH, conf);
        return reply("üîÑ Setup NOT DONE ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶π‡¶≤‡ßã‡•§");
      }
      case "0":
      default:
        return reply(T.cancel);
    }
  }

  if (handleReply.type === "ownerNote") {
    conf.ownerNote = (event.body || "").trim().slice(0, 200);
    writeJSON(CONF_PATH, conf);
    return api.sendMessage(T.done, event.threadID);
  }

  // Toggle pick
  if (handleReply.type === "togglePick") {
    const idx = parseInt((event.body||"").trim(), 10) - 1;
    const list = handleReply.cmds || [];
    if (!(idx >=0 && idx < list.length)) return api.sendMessage("‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞!", event.threadID);
    const name = list[idx];
    let disabled = readJSON(DISABLED_CMDS_PATH);
    if (!Array.isArray(disabled)) disabled = [];

    if (disabled.includes(name)) {
      disabled = disabled.filter(n => n !== name);
      writeJSON(DISABLED_CMDS_PATH, disabled);
      return api.sendMessage(`‚úÖ ${name} ‡¶è‡¶ñ‡¶® ON`, event.threadID);
    } else {
      disabled.push(name);
      writeJSON(DISABLED_CMDS_PATH, disabled);
      return api.sendMessage(`üö´ ${name} ‡¶è‡¶ñ‡¶® OFF`, event.threadID);
    }
  }

  // Delete pick -> confirm
  if (handleReply.type === "deletePick") {
    const idx = parseInt((event.body||"").trim(), 10) - 1;
    const list = handleReply.cmds || [];
    if (!(idx >=0 && idx < list.length)) return api.sendMessage("‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞!", event.threadID);
    const name = list[idx];

    return api.sendMessage(T.confirmDel(name), event.threadID, (err, info) => {
      if (err) return;
      global.client.handleReply.push({
        name: module.exports.config.name,
        messageID: info.messageID,
        author: event.senderID,
        type: "confirmDelete",
        cmdName: name
      });
    });
  }

  if (handleReply.type === "confirmDelete") {
    const ans = (event.body||"").trim().toLowerCase();
    const name = handleReply.cmdName;
    if (!["yes","y","no","n"].includes(ans)) {
      return api.sendMessage("Please reply yes/no", event.threadID);
    }
    if (ans.startsWith("n")) return api.sendMessage(T.cancel, event.threadID);

    // ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
    const safeName = name.replace(/[^a-z0-9_\-]/gi, "");
    const target = path.join(COMMANDS_DIR, `${safeName}.js`);
    if (!fs.existsSync(target)) return api.sendMessage(T.notFound, event.threadID);

    try {
      fs.unlinkSync(target);
      // ‡¶Ø‡¶¶‡¶ø OFF ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶•‡¶æ‡¶ï‡ßá‚Äî‡¶§‡¶æ‡¶ì ‡¶∏‡¶∞‡¶æ‡¶á
      let disabled = readJSON(DISABLED_CMDS_PATH);
      if (Array.isArray(disabled)) {
        disabled = disabled.filter(n => n !== safeName);
        writeJSON(DISABLED_CMDS_PATH, disabled);
      }
      return api.sendMessage(`üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®: ${safeName}.js`, event.threadID);
    } catch (e) {
      return api.sendMessage(`‚ùå ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${e.message}`, event.threadID);
    }
  }
};

// ===== Optional helper (middleware idea) =====
// ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ü‡ßá‡¶∞ command handler-‡¶è DISABLED_CMDS_PATH ‡¶™‡¶°‡¶º‡ßá
// ‡¶Ø‡ßá‡¶∏‡¶¨ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° disabled ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§
// ‡¶®‡¶ø‡¶ö‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶´‡ßç‡¶∞‡ßá‡¶Æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï-‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶á‡¶®‡ßç‡¶ü‡¶ø‡¶ó‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞):

/*
globalBypassCheck = function(commandName, threadID) {
  const disabled = readJSON(DISABLED_CMDS_PATH);
  const blocked = readJSON(BLOCKED_THREADS_PATH);
  if (Array.isArray(blocked) && blocked.includes(threadID)) return false; // block all
  if (Array.isArray(disabled) && disabled.includes(commandName)) return false; // this cmd off
  return true; // allow
};
*/
